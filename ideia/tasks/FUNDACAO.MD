### ğŸ—ï¸ Fase 1: FundaÃ§Ã£o White-Label (4 semanas)

#### 1.1 Sistema de Temas CustomizÃ¡veis â­â­â­

**Objetivo**: Permitir customizaÃ§Ã£o completa da identidade visual.

**Recursos:**
- âœ… Color picker para 8+ cores (primÃ¡ria, secundÃ¡ria, sucesso, erro, etc)
- âœ… Upload de logo (horizontal, vertical, favicon)
- âœ… SeleÃ§Ã£o de fontes do Google Fonts
- âœ… Border radius customizÃ¡vel (0-32px)
- âœ… Light/Dark mode toggle
- âœ… Preview em tempo real
- âœ… Export/Import de temas (JSON)
- âœ… Custom CSS para ajustes avanÃ§ados

**Schema SQL:**
```sql
CREATE TABLE theme_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  organization_id UUID REFERENCES organizations(id),
  
  -- Branding
  brand_name TEXT DEFAULT 'AI Dashboard',
  logo_url TEXT,
  favicon_url TEXT,
  
  -- Colors
  primary_color VARCHAR(7) DEFAULT '#F07D00',
  secondary_color VARCHAR(7) DEFAULT '#000000',
  success_color VARCHAR(7) DEFAULT '#10B981',
  error_color VARCHAR(7) DEFAULT '#EF4444',
  
  -- Typography
  font_family TEXT DEFAULT 'Inter',
  font_size_base INTEGER DEFAULT 16,
  
  -- Layout
  theme_mode VARCHAR(10) DEFAULT 'dark',
  border_radius INTEGER DEFAULT 12,
  custom_css TEXT,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Complexidade:** MÃ©dia | **Tempo:** 1-2 semanas

---

#### 1.2 Multi-Tenancy (OrganizaÃ§Ãµes) â­â­â­

**Objetivo**: Permitir que mÃºltiplos usuÃ¡rios colaborem em organizaÃ§Ãµes.

**Recursos:**
- âœ… Criar/gerenciar organizaÃ§Ãµes
- âœ… Convidar membros via email com token Ãºnico
- âœ… 4 nÃ­veis de permissÃ£o: Owner, Admin, Member, Viewer
- âœ… Compartilhar agentes dentro da organizaÃ§Ã£o
- âœ… Audit log de todas as aÃ§Ãµes
- âœ… Billing por organizaÃ§Ã£o

**Roles & PermissÃµes:**

| AÃ§Ã£o | Owner | Admin | Member | Viewer |
|------|-------|-------|--------|--------|
| Criar agentes | âœ… | âœ… | âœ… | âŒ |
| Editar agentes | âœ… | âœ… | âœ… | âŒ |
| Deletar agentes | âœ… | âœ… | âŒ | âŒ |
| Convidar membros | âœ… | âœ… | âŒ | âŒ |
| Gerenciar billing | âœ… | âŒ | âŒ | âŒ |
| Ver analytics | âœ… | âœ… | âœ… | âœ… |

**Schema SQL:**
```sql
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  owner_id UUID REFERENCES auth.users(id),
  plan_type VARCHAR(20) DEFAULT 'free',
  max_agents INTEGER DEFAULT 3,
  max_members INTEGER DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE organization_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  role VARCHAR(20) DEFAULT 'member',
  status VARCHAR(20) DEFAULT 'active',
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(organization_id, user_id)
);

CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id),
  user_id UUID REFERENCES auth.users(id),
  action VARCHAR(50) NOT NULL,
  resource_type VARCHAR(50),
  resource_id UUID,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Complexidade:** Alta | **Tempo:** 2-3 semanas

---


#### 1.4 Base de Conhecimento com Prompt Engineering â­â­â­

**Objetivo**: Melhorar qualidade das respostas atravÃ©s de metadados contextuais.

**Funcionalidade:**
Ao fazer upload de documentos, exibir dialog solicitando informaÃ§Ãµes para prompt engineering:

**Dialog de Upload:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Upload de Documento para Base de        â”‚
â”‚    Conhecimento                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ Arquivo: contrato-servicos.pdf             â”‚
â”‚                                             â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                             â”‚
â”‚ ğŸ¯ O que hÃ¡ neste documento?               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Contrato de prestaÃ§Ã£o de serviÃ§os   â”‚   â”‚
â”‚ â”‚ com clÃ¡usulas de pagamento e SLA    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ ğŸ“‹ Quando usar este documento?             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Quando cliente perguntar sobre      â”‚   â”‚
â”‚ â”‚ valores, prazos, garantias ou SLA   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ ğŸ”§ Como usar este documento?               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Extrair informaÃ§Ã£o especÃ­fica e     â”‚   â”‚
â”‚ â”‚ citar clÃ¡usula exata do contrato    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ ğŸ’¬ Exemplos de diÃ¡logo: (repeater field)                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ User: "Qual o prazo de entrega?"    â”‚   â”‚
â”‚ â”‚ AI: "Conforme clÃ¡usula 3.2..."     â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ User: "Tem garantia?"               â”‚   â”‚
â”‚ â”‚ AI: "Sim, conforme clÃ¡usula 5.1..." â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ ğŸ·ï¸ Tags (separadas por vÃ­rgula):          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ contrato, pagamento, SLA, garantia  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚    [Cancelar]  [Processar Documento] âœ…   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Recursos:**
- âœ… Dialog modal ao upload
- âœ… 5 campos de contexto (o que, quando, como, exemplos, tags)
- âœ… ValidaÃ§Ã£o mÃ­nima (20 caracteres por campo)
- âœ… SugestÃµes automÃ¡ticas via IA (opcional)
- âœ… Preview do document embedding com contexto
- âœ… EdiÃ§Ã£o posterior dos metadados

**Schema SQL:**
```sql
-- Adicionar colunas Ã  tabela knowledge_documents
ALTER TABLE knowledge_documents ADD COLUMN IF NOT EXISTS
  document_description TEXT, -- O que hÃ¡ no documento
  usage_context TEXT,         -- Quando usar
  usage_instructions TEXT,    -- Como usar
  dialogue_examples JSONB DEFAULT '[]', -- Array de exemplos
  tags TEXT[] DEFAULT '{}',   -- Array de tags
  prompt_metadata JSONB DEFAULT '{}'; -- Metadados extras

-- Ãndices para busca
CREATE INDEX IF NOT EXISTS idx_knowledge_tags ON knowledge_documents USING GIN(tags);
CREATE INDEX IF NOT EXISTS idx_knowledge_metadata ON knowledge_documents USING GIN(prompt_metadata);
```

**Impacto no RAG:**
```typescript
// Ao buscar documentos relevantes, incluir contexto no prompt
const relevantDocs = await searchKnowledge(query);
const contextualPrompt = `
Contexto dos documentos:
${relevantDocs.map(doc => `
- Documento: ${doc.file_name}
- DescriÃ§Ã£o: ${doc.document_description}
- Quando usar: ${doc.usage_context}
- Como usar: ${doc.usage_instructions}
- Exemplos de diÃ¡logo:
${JSON.parse(doc.dialogue_examples).map(ex => `  User: "${ex.user}"\n  AI: "${ex.ai}"`).join('\n')}
`).join('\n')}

Pergunta do usuÃ¡rio: ${query}
`;
```

**Complexidade:** MÃ©dia | **Tempo:** 1 semana

---

#### 1.5 Base de Conhecimento via URL (Web Scraper) â­â­â­

**Objetivo**: Processar conteÃºdo de sites automaticamente para base de conhecimento.

**Funcionalidade:**
- âœ… Input para adicionar URL
- âœ… MicrosserviÃ§o scraper (Edge Function)
- âœ… ExtraÃ§Ã£o inteligente de conteÃºdo (remove menu, sidebar, footer)
- âœ… Processamento e vetorizaÃ§Ã£o automÃ¡tica
- âœ… Loading visual durante processamento
- âœ… Re-crawl automÃ¡tico (atualizaÃ§Ã£o periÃ³dica)

**UI de Upload por URL:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ Adicionar URL Ã  Base de Conhecimento    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ URL do site:                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ https://docs.example.com/api        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ âš™ï¸ OpÃ§Ãµes:                                 â”‚
â”‚ â–¡ Crawl subpÃ¡ginas (atÃ© 3 nÃ­veis)         â”‚
â”‚ â–¡ AtualizaÃ§Ã£o automÃ¡tica (semanal)        â”‚
â”‚                                             â”‚
â”‚ ğŸ¯ Contexto (opcional):                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ DocumentaÃ§Ã£o da API REST            â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚    [Cancelar]  [Processar URL] ğŸš€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â³ Processando URL...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 45%

âœ“ PÃ¡gina carregada (2.3s)
âœ“ ConteÃºdo extraÃ­do (1.547 palavras)
â³ Vetorizando chunks (12/25)
```

**Schema SQL:**
```sql
CREATE TABLE knowledge_urls (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agent_id UUID REFERENCES agents(id) ON DELETE CASCADE,
  url TEXT NOT NULL,
  crawl_depth INTEGER DEFAULT 1,
  auto_refresh BOOLEAN DEFAULT false,
  refresh_frequency VARCHAR(20) DEFAULT 'weekly', -- daily, weekly, monthly
  
  -- Status do processamento
  status VARCHAR(20) DEFAULT 'pending', -- pending, processing, completed, failed
  last_crawled_at TIMESTAMP WITH TIME ZONE,
  next_crawl_at TIMESTAMP WITH TIME ZONE,
  
  -- Metadados extraÃ­dos
  page_title TEXT,
  word_count INTEGER,
  chunks_generated INTEGER,
  content_hash VARCHAR(64), -- Para detectar mudanÃ§as
  
  -- Contexto
  document_description TEXT,
  tags TEXT[] DEFAULT '{}',
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_knowledge_urls_agent ON knowledge_urls(agent_id);
CREATE INDEX idx_knowledge_urls_next_crawl ON knowledge_urls(next_crawl_at) WHERE auto_refresh = true;
```

**MicrosserviÃ§o Scraper (Edge Function):**
```typescript
// supabase/functions/web-scraper/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import * as cheerio from 'https://esm.sh/cheerio@1.0.0-rc.12';

serve(async (req) => {
  const { url, agentId } = await req.json();
  
  try {
    // 1. Fetch URL
    const response = await fetch(url);
    const html = await response.text();
    
    // 2. Parse com Cheerio
    const $ = cheerio.load(html);
    
    // 3. Remove elementos indesejados
    $('nav, header, footer, aside, .sidebar, .menu, script, style, iframe').remove();
    
    // 4. Extrai conteÃºdo principal (heurÃ­sticas)
    const mainContent = $('main, article, .content, #content, .post-content').first();
    const text = mainContent.length > 0 
      ? mainContent.text() 
      : $('body').text();
    
    // 5. Limpa texto
    const cleanText = text
      .replace(/\s+/g, ' ')
      .trim();
    
    // 6. Extrai metadados
    const title = $('title').text() || $('h1').first().text();
    const wordCount = cleanText.split(' ').length;
    
    // 7. Chunking (500 palavras por chunk, overlap 50)
    const chunks = chunkText(cleanText, 500, 50);
    
    // 8. Gera embeddings
    const embeddings = await generateEmbeddings(chunks);
    
    // 9. Salva no banco
    for (let i = 0; i < chunks.length; i++) {
      await supabase.from('knowledge_documents').insert({
        agent_id: agentId,
        file_name: `${title} (chunk ${i+1})`,
        content: chunks[i],
        embedding: embeddings[i],
        source_url: url,
        source_type: 'url',
        metadata: {
          title,
          chunk_index: i,
          total_chunks: chunks.length
        }
      });
    }
    
    // 10. Atualiza status
    await supabase.from('knowledge_urls').update({
      status: 'completed',
      last_crawled_at: new Date().toISOString(),
      page_title: title,
      word_count: wordCount,
      chunks_generated: chunks.length,
      content_hash: hashContent(cleanText)
    }).eq('url', url);
    
    return new Response(JSON.stringify({
      success: true,
      chunks: chunks.length,
      wordCount
    }), { headers: { 'Content-Type': 'application/json' } });
    
  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), { status: 500 });
  }
});
```

**Cron Job para Auto-Refresh:**
```sql
-- Trigger diÃ¡rio para verificar URLs que precisam atualizaÃ§Ã£o
SELECT cron.schedule(
  'refresh-knowledge-urls',
  '0 2 * * *', -- 2h da manhÃ£ todo dia
  $$
  SELECT net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/web-scraper-refresh',
    headers := '{"Content-Type": "application/json"}'::jsonb
  ) FROM knowledge_urls 
  WHERE auto_refresh = true 
    AND next_crawl_at <= NOW();
  $$
);
```

**Complexidade:** Alta | **Tempo:** 2 semanas

---

#### 1.6 Widget/Iframe IncorporÃ¡vel â­â­â­

**Objetivo**: Permitir incorporar agentes em sites externos via iframe ou snippet JS.

**Funcionalidades:**
- âœ… Gerador de cÃ³digo embed
- âœ… Iframe responsivo
- âœ… Widget customizÃ¡vel (cores, posiÃ§Ã£o, tamanho)
- âœ… Bubble chat (minimizÃ¡vel)
- âœ… Full-page embed
- âœ… CORS configurÃ¡vel
- âœ… Analytics de origem

**UI de GeraÃ§Ã£o de Widget:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”Œ Widget / Embed do Agente                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ Agente: Suporte TÃ©cnico v2                 â”‚
â”‚                                             â”‚
â”‚ ğŸ¨ Estilo do Widget:                        â”‚
â”‚ â¦¿ Bubble Chat (canto inferior direito)     â”‚
â”‚ â—‹ Full Chat (largura total)                â”‚
â”‚ â—‹ Inline (incorporado na pÃ¡gina)           â”‚
â”‚                                             â”‚
â”‚ Cor principal: [#FF6B00] ğŸ¨                 â”‚
â”‚ PosiÃ§Ã£o: â–¾ Bottom Right                    â”‚
â”‚ Tamanho: â–¾ Medium (400x600px)              â”‚
â”‚                                             â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                             â”‚
â”‚ ğŸ“‹ CÃ³digo para incorporar:                 â”‚
â”‚                                             â”‚
â”‚ HTML (Iframe):                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ <iframe                             â”‚   â”‚
â”‚ â”‚   src="https://app.venturize.ai/    â”‚   â”‚
â”‚ â”‚        widget/abc123"               â”‚   â”‚
â”‚ â”‚   width="400" height="600"          â”‚   â”‚
â”‚ â”‚   frameborder="0"                   â”‚   â”‚
â”‚ â”‚   allow="clipboard-write"           â”‚   â”‚
â”‚ â”‚ ></iframe>                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          [Copiar] ğŸ“‹       â”‚
â”‚                                             â”‚
â”‚ JavaScript (Widget):                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ <script>                            â”‚   â”‚
â”‚ â”‚ (function(){                        â”‚   â”‚
â”‚ â”‚   var s=document.createElement(     â”‚   â”‚
â”‚ â”‚     'script');                      â”‚   â”‚
â”‚ â”‚   s.src='https://app.venturize.ai/  â”‚   â”‚
â”‚ â”‚          widget.js?id=abc123';      â”‚   â”‚
â”‚ â”‚   document.body.appendChild(s);     â”‚   â”‚
â”‚ â”‚ })();                               â”‚   â”‚
â”‚ â”‚ </script>                           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          [Copiar] ğŸ“‹       â”‚
â”‚                                             â”‚
â”‚ ğŸ‘ï¸ Preview:                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚  [Preview do widget ao vivo aqui]  â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas:                â”‚
â”‚ â˜‘ï¸ Permitir iframe em qualquer domÃ­nio     â”‚
â”‚ â˜‘ï¸ Registrar origem das conversas          â”‚
â”‚ â–¡ Modo somente-leitura (demo)             â”‚
â”‚                                             â”‚
â”‚ ğŸŒ DomÃ­nios Autorizados:                   â”‚
â”‚ â€¢ example.com                              â”‚
â”‚ â€¢ app.example.com                          â”‚
â”‚ + Adicionar domÃ­nio                        â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Schema SQL:**
```sql
CREATE TABLE agent_widgets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agent_id UUID REFERENCES agents(id) ON DELETE CASCADE,
  widget_id VARCHAR(50) UNIQUE NOT NULL, -- ID pÃºblico (abc123)
  
  -- ConfiguraÃ§Ãµes visuais
  widget_type VARCHAR(20) DEFAULT 'bubble', -- bubble, full, inline
  primary_color VARCHAR(7) DEFAULT '#FF6B00',
  position VARCHAR(20) DEFAULT 'bottom-right',
  width INTEGER DEFAULT 400,
  height INTEGER DEFAULT 600,
  
  -- SeguranÃ§a
  allowed_domains TEXT[] DEFAULT '{}', -- Whitelist de domÃ­nios
  allow_all_domains BOOLEAN DEFAULT false,
  require_auth BOOLEAN DEFAULT false,
  
  -- Analytics
  total_impressions INTEGER DEFAULT 0,
  total_conversations INTEGER DEFAULT 0,
  
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE widget_analytics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  widget_id UUID REFERENCES agent_widgets(id),
  referrer_url TEXT,
  referrer_domain TEXT,
  user_agent TEXT,
  conversation_id UUID,
  event_type VARCHAR(20), -- impression, open, close, message
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_widget_analytics_widget ON widget_analytics(widget_id);
CREATE INDEX idx_widget_analytics_domain ON widget_analytics(referrer_domain);
```

**Widget JavaScript (Public):**
```javascript
// public/widget.js
(function() {
  const widgetId = new URLSearchParams(window.currentScript.src.split('?')[1]).get('id');
  
  // Criar container do widget
  const container = document.createElement('div');
  container.id = 'venturize-widget';
  container.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
  `;
  
  // Criar bubble button
  const bubble = document.createElement('div');
  bubble.style.cssText = `
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FF6B00, #FF8C00);
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(255, 107, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s;
  `;
  bubble.innerHTML = `
    <svg width="28" height="28" viewBox="0 0 24 24" fill="white">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
    </svg>
  `;
  
  // Criar iframe
  const iframe = document.createElement('iframe');
  iframe.src = `https://app.venturize.ai/widget/${widgetId}`;
  iframe.style.cssText = `
    width: 400px;
    height: 600px;
    border: none;
    border-radius: 16px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.3);
    display: none;
    position: absolute;
    bottom: 80px;
    right: 0;
  `;
  
  // Toggle chat
  let isOpen = false;
  bubble.addEventListener('click', () => {
    isOpen = !isOpen;
    iframe.style.display = isOpen ? 'block' : 'none';
    bubble.style.transform = isOpen ? 'scale(0.9)' : 'scale(1)';
    
    // Analytics
    if (isOpen) {
      fetch(`https://app.venturize.ai/api/widget-analytics`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          widgetId,
          eventType: 'open',
          referrer: window.location.href
        })
      });
    }
  });
  
  container.appendChild(bubble);
  container.appendChild(iframe);
  document.body.appendChild(container);
  
  // Impression tracking
  fetch(`https://app.venturize.ai/api/widget-analytics`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      widgetId,
      eventType: 'impression',
      referrer: window.location.href
    })
  });
})();
```

**Complexidade:** MÃ©dia | **Tempo:** 1-2 semanas

---

#### 1.7 Sistema de Feedback e Aprendizado ContÃ­nuo â­â­â­

**Objetivo**: Melhorar respostas atravÃ©s de feedback dos usuÃ¡rios e aprendizado supervisionado.

**Funcionalidades:**
- âœ… Feedback positivo/negativo em cada resposta
- âœ… Input de correÃ§Ã£o/melhoria (30 palavras por bloco)
- âœ… DivisÃ£o de respostas em blocos para feedback granular
- âœ… Fine-tuning dataset generation
- âœ… A/B testing de respostas melhoradas
- âœ… Dashboard de qualidade das respostas

**UI no Chat:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Chat com Agente de Suporte              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ‘¤ User:                                    â”‚
â”‚ Como faÃ§o para cancelar minha assinatura?  â”‚
â”‚                                             â”‚
â”‚ ğŸ¤– AI:                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Para cancelar sua assinatura, siga â”‚   â”‚
â”‚ â”‚ estes passos:                       â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ 1. Acesse ConfiguraÃ§Ãµes > Billing   â”‚   â”‚
â”‚ â”‚ 2. Clique em "Gerenciar Assinatura"â”‚   â”‚
â”‚ â”‚ 3. Selecione "Cancelar"             â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ [Bloco 1/2]                         â”‚   â”‚
â”‚ â”‚ ğŸ‘ 12  ğŸ‘ 1  âœï¸ Melhorar             â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Importante: O cancelamento terÃ¡    â”‚   â”‚
â”‚ â”‚ efeito no final do perÃ­odo atual.   â”‚   â”‚
â”‚ â”‚ VocÃª continuarÃ¡ tendo acesso atÃ©    â”‚   â”‚
â”‚ â”‚ entÃ£o.                              â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ [Bloco 2/2]                         â”‚   â”‚
â”‚ â”‚ ğŸ‘ 15  ğŸ‘ 0  âœï¸ Melhorar             â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ ğŸ“Š Resposta geral: ğŸ‘ 27  ğŸ‘ 1  (96%)     â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// Ao clicar em "Melhorar":
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœï¸ Melhorar esta resposta                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ Bloco original:                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Para cancelar sua assinatura, siga â”‚   â”‚
â”‚ â”‚ estes passos:                       â”‚   â”‚
â”‚ â”‚ 1. Acesse ConfiguraÃ§Ãµes > Billing   â”‚   â”‚
â”‚ â”‚ 2. Clique em "Gerenciar Assinatura"â”‚   â”‚
â”‚ â”‚ 3. Selecione "Cancelar"             â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ â“ O que estÃ¡ errado ou pode melhorar?     â”‚
â”‚ â—‹ InformaÃ§Ã£o incorreta                     â”‚
â”‚ â—‹ InformaÃ§Ã£o incompleta                    â”‚
â”‚ â— Tom inadequado                            â”‚
â”‚ â—‹ FormataÃ§Ã£o ruim                          â”‚
â”‚ â—‹ Outro                                    â”‚
â”‚                                             â”‚
â”‚ ğŸ’¡ SugestÃ£o de melhoria (mÃ¡x 30 palavras): â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Adicionar link direto para pÃ¡gina   â”‚   â”‚
â”‚ â”‚ de billing e mencionar que nÃ£o hÃ¡   â”‚   â”‚
â”‚ â”‚ taxa de cancelamento.                â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ (27/30 palavras)                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚    [Cancelar]  [Enviar Feedback] âœ…        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Schema SQL:**
```sql
CREATE TABLE message_feedback (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  message_id UUID REFERENCES chat_messages(id) ON DELETE CASCADE,
  conversation_id UUID REFERENCES chat_sessions(id),
  agent_id UUID REFERENCES agents(id),
  
  -- Feedback geral
  feedback_type VARCHAR(10) NOT NULL, -- positive, negative
  
  -- Bloco especÃ­fico (se resposta dividida)
  block_index INTEGER, -- null = feedback geral
  block_content TEXT,
  
  -- Detalhes do problema
  issue_category VARCHAR(30), -- incorrect, incomplete, tone, formatting, other
  
  -- SugestÃ£o de melhoria
  improvement_suggestion TEXT, -- mÃ¡x 30 palavras por bloco
  
  -- Metadata
  user_id UUID,
  ip_address INET,
  user_agent TEXT,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE response_improvements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agent_id UUID REFERENCES agents(id),
  original_response TEXT NOT NULL,
  improved_response TEXT NOT NULL,
  
  -- Tracking de origem
  based_on_feedback_count INTEGER DEFAULT 1,
  improvement_sources UUID[] DEFAULT '{}', -- IDs dos feedbacks que geraram isso
  
  -- A/B Testing
  status VARCHAR(20) DEFAULT 'testing', -- testing, approved, rejected
  test_group VARCHAR(10) DEFAULT 'B', -- A = original, B = improved
  
  -- MÃ©tricas de A/B test
  impressions_a INTEGER DEFAULT 0,
  impressions_b INTEGER DEFAULT 0,
  positive_feedback_a INTEGER DEFAULT 0,
  positive_feedback_b INTEGER DEFAULT 0,
  negative_feedback_a INTEGER DEFAULT 0,
  negative_feedback_b INTEGER DEFAULT 0,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  approved_at TIMESTAMP WITH TIME ZONE
);

CREATE TABLE response_blocks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  message_id UUID REFERENCES chat_messages(id) ON DELETE CASCADE,
  block_index INTEGER NOT NULL,
  block_content TEXT NOT NULL,
  word_count INTEGER,
  
  -- Feedback agregado
  positive_count INTEGER DEFAULT 0,
  negative_count INTEGER DEFAULT 0,
  improvement_suggestions JSONB DEFAULT '[]',
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_message_feedback_message ON message_feedback(message_id);
CREATE INDEX idx_message_feedback_agent ON message_feedback(agent_id);
CREATE INDEX idx_response_improvements_agent ON response_improvements(agent_id);
CREATE INDEX idx_response_blocks_message ON response_blocks(message_id);
```

**Componente React de Feedback:**
```typescript
// src/components/MessageFeedback.tsx
interface MessageFeedbackProps {
  messageId: string;
  blocks: Array<{ index: number; content: string }>;
}

export function MessageFeedback({ messageId, blocks }: MessageFeedbackProps) {
  const [blockFeedback, setBlockFeedback] = useState<Record<number, 'positive' | 'negative'>>({});
  const [improvementModal, setImprovementModal] = useState<{
    open: boolean;
    blockIndex: number;
    blockContent: string;
  } | null>(null);
  
  const handleFeedback = async (blockIndex: number, type: 'positive' | 'negative') => {
    setBlockFeedback(prev => ({ ...prev, [blockIndex]: type }));
    
    await supabase.from('message_feedback').insert({
      message_id: messageId,
      block_index: blockIndex,
      block_content: blocks[blockIndex].content,
      feedback_type: type
    });
    
    // Incrementar contador
    await supabase.rpc('increment_block_feedback', {
      p_message_id: messageId,
      p_block_index: blockIndex,
      p_feedback_type: type
    });
  };
  
  const handleImprovement = async (data: {
    blockIndex: number;
    issueCategory: string;
    suggestion: string;
  }) => {
    await supabase.from('message_feedback').insert({
      message_id: messageId,
      block_index: data.blockIndex,
      block_content: blocks[data.blockIndex].content,
      feedback_type: 'negative',
      issue_category: data.issueCategory,
      improvement_suggestion: data.suggestion
    });
    
    setImprovementModal(null);
    toast.success('Obrigado pelo feedback! Usaremos para melhorar.');
  };
  
  return (
    <div className="message-feedback">
      {blocks.map((block, index) => (
        <div key={index} className="response-block">
          <div className="block-content">{block.content}</div>
          
          <div className="block-actions">
            <span className="block-label">Bloco {index + 1}/{blocks.length}</span>
            
            <button
              onClick={() => handleFeedback(index, 'positive')}
              className={blockFeedback[index] === 'positive' ? 'active' : ''}
            >
              ğŸ‘ {block.positiveCount || 0}
            </button>
            
            <button
              onClick={() => handleFeedback(index, 'negative')}
              className={blockFeedback[index] === 'negative' ? 'active' : ''}
            >
              ğŸ‘ {block.negativeCount || 0}
            </button>
            
            <button
              onClick={() => setImprovementModal({
                open: true,
                blockIndex: index,
                blockContent: block.content
              })}
            >
              âœï¸ Melhorar
            </button>
          </div>
        </div>
      ))}
      
      {improvementModal && (
        <ImprovementModal
          {...improvementModal}
          onClose={() => setImprovementModal(null)}
          onSubmit={handleImprovement}
        />
      )}
    </div>
  );
}
```

**Fine-tuning Dataset Generation:**
```typescript
// Gerar dataset de fine-tuning a partir dos feedbacks
async function generateFineTuningDataset(agentId: string) {
  const feedbacks = await supabase
    .from('message_feedback')
    .select('*')
    .eq('agent_id', agentId)
    .eq('feedback_type', 'negative')
    .not('improvement_suggestion', 'is', null);
  
  const dataset = feedbacks.map(fb => ({
    prompt: `User question: ${fb.original_query}\n\nOriginal response:\n${fb.block_content}\n\nImprovement needed: ${fb.issue_category}\n\nSuggested improvement: ${fb.improvement_suggestion}\n\nProvide improved response:`,
    completion: fb.improvement_suggestion
  }));
  
  // Exportar para JSONL (formato OpenAI)
  const jsonl = dataset.map(d => JSON.stringify(d)).join('\n');
  
  return jsonl;
}
```

**Dashboard de Qualidade:**
```typescript
// MÃ©tricas de qualidade por agente
const qualityMetrics = await supabase.rpc('get_agent_quality_metrics', {
  p_agent_id: agentId
});

// Retorna:
// {
//   total_responses: 1247,
//   total_feedback: 823,
//   positive_rate: 0.89,
//   negative_rate: 0.11,
//   top_issues: [
//     { category: 'incomplete', count: 45 },
//     { category: 'tone', count: 32 }
//   ],
//   improvement_suggestions: 91,
//   blocks_with_issues: [
//     { block_content: "...", negative_count: 12 }
//   ]
// }
```

**Complexidade:** Alta | **Tempo:** 2-3 semanas

---